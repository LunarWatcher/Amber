vim9script

import autoload "amber.vim"

def comment(line: string): string
    return '" ' .. line 
enddef

def variable(name: string, value: string): string
    var fragment = 's:' .. name .. " = '" .. value .. "'"
    return 'let ' .. fragment
enddef


def assembleGroup(groupContent: list<string>, vim9: number = 0): list<any>
    var needsExec = 0
    var construct = ""
    for data in groupContent
        if stridx(data, '=') != -1
            construct = construct .. " " ..  data
        else
            needsExec = 1
            construct = construct .. '" ' .. repeat('.', 1 + vim9) ..
                ' ' .. data .. ' ' .. repeat('.', 1 + vim9) .. ' " '
        endif
    endfor
    
    return [ needsExec, construct ]
enddef

def generateVimscript(filename: string)
    var lines: list<string> = []

    add(lines, comment('Theme name: ' .. filename))

    for [k, v] in items(g:AmberMeta)
        add(lines, comment(k .. ': ' .. v))
    endfor
    add(lines, '')
    add(lines, comment('Theme code generated by Amber: https://github.com/lunarwatcher/amber'))

    var comments = {}
    var fileLines = getline(0, '$')
    var counter: number = 0

    for line in fileLines
        if line =~ "^#"
            add(lines, comment(trim(line[1 : ])))
            continue
        endif

        hlsearch)-
        g:AmberVariables = {}
        g:AmberHighlights = {}
        g:AmberRawCode = []
        amber.Compile(line, 1)

        for [variableName, value] in items(g:AmberVariables)
            add(lines, variable(variableName, value)) 
        endfor

        for [groupName, groupContent] in items(g:AmberHighlights)
            if type(groupContent) == v:t_string
                if (stridx(groupContent, "link=") >= 0)
                    # Link is a special case because of the different syntax
                    add(lines, 'hi! link ' .. groupName .. ' ' .. split(groupContent, '=')[1])
                else
                    add(lines, 'hi ' .. groupName .. ' ' .. groupContent)
                endif
            else
                var raw = assembleGroup(groupContent)
                var needsExec = raw[0]
                var construct = raw[1]
                if !needsExec
                    add(lines, 'hi ' .. groupName .. ' ' .. construct)
                else
                    add(lines, 'exec "hi ' .. groupName .. ' ' .. substitute(trim(construct), "'", "''", 'g') .. '"')
                endif
            endif

        endfor
        for code in g:AmberRawCode
            extend(lines, code)
        endfor
    endfor
    
    writefile(lines, g:AmberOutputDirectory .. '/' .. filename .. ".vim")

enddef
